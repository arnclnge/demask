---
author: "Arienne Calonge"
date: "2025-07-30"
title: "ICES NS-IBTS data availability"
output: 
  html_document:
    self_contained: true
runtime: shiny
---
---

## Harvesting data from ICES DATRAS
Setup libraries
```{r, echo=FALSE}
library(tidyverse)
library(icesDatras)
library(icesAdvice)
library(icesVocab)
library(mapplots)
library(leaflet)
library(shiny)
```

## 1. Harvest data
```{r, echo=FALSE, eval=FALSE}
#find species codes in icesVocab

aphia_sp <- findAphia(c("Gadus morhua", "Melanogrammus aeglefinus", "Clupea harengus", "Dicentrarchus labrax", "Molva molva"), latin = TRUE)

names(aphia_sp) <- c("Gadus morhua", "Melanogrammus aeglefinus", "Clupea harengus", "Dicentrarchus labrax", "Molva molva")
aphia_lookup <- setNames(names(aphia_sp), aphia_sp)

#check availability of data from ICES DATRAS

    getDatrasDataOverview(surveys = 'NS-IBTS', long = TRUE)
    
    # Initialize empty list to store results
    all_catch <- list()
    
    # Loop through years
    for (yr in 2000:2024) {
      cat("Processing year:", yr, "\n")
      result <- getCatchWgt(
        survey = 'NS-IBTS',
        years = yr,
        quarters = c(1,3),
        aphia = c(126436, 126437, 126417, 126975, 126461)
      )
      all_catch[[as.character(yr)]] <- result
      print(yr)
    }
    
    # Merge all data frames into one
    CatchWgt <- do.call(rbind, all_catch)
    
    write_csv(CatchWgt, 'CatchWeight_200024.csv')

# Get length-based information such as measured length, individual counts, and sub-factors of sampled species

    HL = getHLdata(survey= 'NS-IBTS', year = 2023:2024, quarter = 1:4)

# adult and larvae?
```

## 2. Clean data 
```{r, echo=FALSE, eval=FALSE}
    colnames(CatchWgt)
    colSums(is.na(CatchWgt)) > 0
    
    # explore columns that are NA
    subset_NA <- CatchWgt[is.na(CatchWgt$HaulDUr), ]
    
    # retain only samples with haul durations of 13 to 66 mins and average haul depth of <= 250 m and eliminate duplicated occurrences
    range(CatchWgt$HaulDur)
    CatchWgt_proc = CatchWgt %>% filter(HaulDur >= 25 & HaulDur <=35) %>% filter(Depth <= 250) %>% distinct()
    CatchWgt_proc <- CatchWgt_proc[!is.na(CatchWgt_proc$CatchWgt), ]
    
    # remove if haul positions missing or same as shoot position
    CatchWgt_proc <- CatchWgt_proc[!(CatchWgt_proc$HaulLat == CatchWgt_proc$ShootLat & CatchWgt_proc$HaulLong == CatchWgt_proc$ShootLong), ]
    
    # check if haullong and haullat are in the correct ICES statrec
    CatchWgt_proc$CalculatedStatRec <- ices.rect2(CatchWgt_proc$HaulLong, CatchWgt_proc$HaulLat)
    wrong_statrec <- CatchWgt_proc[CatchWgt_proc$StatRec != CatchWgt_proc$CalculatedStatRec, ]
    
    CatchWgt_proc <- CatchWgt_proc[CatchWgt_proc$StatRec == CatchWgt_proc$CalculatedStatRec, ]
    
    CatchWgt_proc <- CatchWgt_proc[rowSums(is.na(CatchWgt_proc)) != ncol(CatchWgt_proc), ]
    
    CatchWgt_proc$SpeciesName <- aphia_lookup[as.character(CatchWgt_proc$Valid_Aphia)]
    
    write_csv(CatchWgt_proc, 'CatchWeight_200024_proc.csv')
    
    # check completeness of data per species
    
    summary_data = CatchWgt_proc %>% group_by(Valid_Aphia, Year, Quarter) %>% summarize(NoHauls = n())
    
    quarter_coverage <- CatchWgt_proc %>%
      distinct(Valid_Aphia, Year, Quarter) %>%
      group_by(Valid_Aphia, Year) %>%
      summarize(QuartersPresent = n(), .groups = "drop")
    
    quarter_coverage <- quarter_coverage %>%
      mutate(Coverage = case_when(
        QuartersPresent == 2 ~ "Both",
        QuartersPresent == 1 ~ "One",
        TRUE ~ "None"
      ))
    
    # Get full species-year grid
    full_grid <- expand.grid(
      Valid_Aphia = unique(CatchWgt_proc$Valid_Aphia),
      Year = unique(CatchWgt_proc$Year)
    )
    
    # Join to add missing combinations as NA
    coverage_full <- full_grid %>%
      left_join(quarter_coverage, by = c("Valid_Aphia", "Year")) %>%
      mutate(Coverage = ifelse(is.na(Coverage), "None", Coverage))
    
    ggplot(coverage_full, aes(x = Year, y = as.factor(Valid_Aphia), fill = Coverage)) +
      geom_tile(color = "white") +
      scale_fill_manual(values = c("None" = "gray90", "One" = "orange", "Both" = "steelblue")) +
      labs(
        title = "Quarter 1 & 3 Coverage by Species and Year",
        x = "Year",
        y = "Species (Valid_Aphia)",
        fill = "Coverage"
      ) +
      theme_minimal() +
      theme(axis.text.y = element_text(size = 8))

save(CatchWgt_proc, file = "CatchWgt_proc.RData")
```

#Load cleaned data from 2015
```{r}
load("CatchWgt_proc.RData")

CatchWgt_proc = CatchWgt_proc %>% filter(Year >= 2015)
```

## 3. Map occurrences 
Remove shoot/haul positions outside North Sea range

```{r ui, echo=FALSE}
selectInput("SpeciesName", "Select species:", choices = unique(CatchWgt_proc$SpeciesName))

leafletOutput("map", height = 500)
```

```{r}
output$map <- renderLeaflet({
  req(input$SpeciesName)

  filtered <- CatchWgt_proc %>%
    filter(SpeciesName == input$SpeciesName)

  leaflet(data = filtered) %>%
    addTiles() %>%
    addCircleMarkers(
      lng = ~HaulLong, lat = ~HaulLat,  # double-check if column is HaulLon or HaulLong
      popup = ~paste("Species:", SpeciesName),
      radius = 5,
      color = "blue"
    )
})
```

```try HERAS

```